<Window x:Class="PCSXMemoryEditor.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:control="clr-namespace:WpfHexaEditor;assembly=WpfHexaEditor"
        Title="PCSX2 内存专业编辑工具 (PCSX2 Professional Memory Editor)" Height="1200" Width="1250">

    <Grid Background="#F5F5F5">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="#ECECEC" BorderBrush="#CCCCCC" BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal" Margin="5">
                <Button Content="连接 PCSX2 (Connect)" Click="Connect_Click" Padding="12,6" Margin="5"/>
                <Button Content="刷新视图 (Refresh)" Click="RefreshHex_Click" 
                        Padding="12,6" Margin="5" Background="#E8F5E9" BorderBrush="#A5D6A7"/>
                <Button Content="导出内存镜像 (Export Dump)" Click="ExportMemory_Click" Padding="12,6" Margin="5"/>

                <Separator Margin="10,0" Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}"/>

                <TextBlock Text="跳转地址 (Jump): 0x" VerticalAlignment="Center" FontWeight="Bold"/>
                <TextBox x:Name="TxtAddress" Width="120" VerticalContentAlignment="Center" Margin="5,0" Text="20000000" FontFamily="Consolas"/>
                <Button Content="跳转 (Go)" Click="GoToAddress_Click" Padding="15,2" Margin="5"/>

                <Button Content="锁定当前项 (Lock Selection)" Click="LockCurrentAddress_Click" 
                        Padding="10,2" Margin="5" Background="#FFE0B2" BorderBrush="#FFB74D"/>

                <Separator Margin="10,0" Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}"/>

                <CheckBox x:Name="ChkHexDecimal" 
                          Content="16进制模式 (Hex Mode)" IsChecked="True" 
                          VerticalAlignment="Center" Margin="5,0" 
                          Click="ToggleHexDec_Click"/>
            </StackPanel>
        </Border>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="4"/>
                <ColumnDefinition Width="380"/>
            </Grid.ColumnDefinitions>

            <control:HexEditor Grid.Column="0" 
                               x:Name="MyHexEditor" 
                               AllowAutoHighLightSelectionByte="False"
                               HeaderVisibility="Visible" 
                               ReadOnlyMode="False" 
                               FontFamily="Consolas" 
                               FontSize="14"
                               BytePerLine="16"
                               Foreground="Black"
                               Background="White"/>

            <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" Background="#DDD"/>

            <Border Grid.Column="2" Background="#FFFFFF" BorderBrush="#CCC" BorderThickness="1,0,0,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="15">
                        <TextBlock Text="内存搜索 (Memory Search)" FontSize="18" FontWeight="Bold" Foreground="#333" Margin="0,0,0,10"/>

                        <Grid Margin="0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="100"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <Label Grid.Row="0" Grid.Column="0" Content="数据类型 (Type):"/>
                            <ComboBox Grid.Row="0" Grid.Column="1" x:Name="ComboDataType" SelectedIndex="2" Margin="0,2">
                                <ComboBoxItem Content="Byte (1 Byte)" Tag="1"/>
                                <ComboBoxItem Content="Int16 (2 Bytes)" Tag="2"/>
                                <ComboBoxItem Content="Int32 (4 Bytes)" Tag="4"/>
                                <ComboBoxItem Content="Float (Floating)" Tag="Float"/>
                            </ComboBox>

                            <Label Grid.Row="1" Grid.Column="0" Content="搜索数值 (Value):"/>
                            <TextBox Grid.Row="1" Grid.Column="1" x:Name="TxtSearchValue" Padding="3" Margin="0,5" FontFamily="Consolas"/>
                        </Grid>

                        <UniformGrid Columns="2" Margin="0,5">
                            <Button Content="首次扫描 (First Scan)" Click="FirstScan_Click" Height="32" Background="#E1F5FE"/>
                            <Button Content="再次扫描 (Next Scan)" Click="NextScan_Click" Height="32" Margin="5,0,0,0" Background="#E1F5FE"/>
                        </UniformGrid>

                        <TextBlock Text="变化追踪 (Change Tracking - vs Last Snapshot)" FontSize="12" Margin="0,15,0,5" Foreground="#666" FontWeight="SemiBold"/>
                        <UniformGrid Columns="2">
                            <Button Content="数值增加了 (+ Increased)" Click="FilterChanged_Click" Tag="Increased" Height="30" Margin="0,2" Background="#F1F8E9"/>
                            <Button Content="数值减少了 (- Decreased)" Click="FilterChanged_Click" Tag="Decreased" Height="30" Margin="5,2,0,2" Background="#FFEBEE"/>
                            <Button Content="数值变动了 (!= Changed)" Click="FilterChanged_Click" Tag="Changed" Height="30" Margin="0,2"/>
                            <Button Content="数值未变动 (== Unchanged)" Click="FilterChanged_Click" Tag="Unchanged" Height="30" Margin="5,2,0,2"/>
                        </UniformGrid>

                        <TextBlock x:Name="TxtStatus" Text="结果 (Results): 0" Foreground="#007ACC" Margin="0,10,0,5" FontWeight="Bold"/>

                        <DataGrid x:Name="ResultGrid" Height="220" AutoGenerateColumns="False" 
                                  IsReadOnly="True" MouseDoubleClick="ResultGrid_MouseDoubleClick"
                                  SelectionMode="Single" Background="#F0F0F0">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="PS2地址 (Address)" Binding="{Binding Address}" Width="110"/>
                                <DataGridTextColumn Header="当前值 (Value)" Binding="{Binding Value}" Width="*"/>
                                <DataGridTextColumn Header="H0" Binding="{Binding History0}" Width="SizeToCells"/>
                                <DataGridTextColumn Header="H1" Binding="{Binding History1}" Width="SizeToCells"/>
                                <DataGridTextColumn Header="H2" Binding="{Binding History2}" Width="SizeToCells"/>
                                <DataGridTextColumn Header="H3" Binding="{Binding History3}" Width="SizeToCells"/>
                                <DataGridTextColumn Header="H4" Binding="{Binding History4}" Width="SizeToCells"/>
                                <DataGridTextColumn Header="H5" Binding="{Binding History5}" Width="SizeToCells"/>
                                <DataGridTextColumn Header="H6" Binding="{Binding History6}" Width="SizeToCells"/>
                                <DataGridTextColumn Header="H7" Binding="{Binding History7}" Width="SizeToCells"/>
                                <DataGridTextColumn Header="H8" Binding="{Binding History8}" Width="SizeToCells"/>
                                <DataGridTextColumn Header="H9" Binding="{Binding History9}" Width="SizeToCells"/>
                            </DataGrid.Columns>
                        </DataGrid>

                        <Button Content="将选中项加入锁定 (Add Selected to Freeze)" Click="BtnAddFreeze_Click" Margin="0,12" Height="35" 
                                Background="#007ACC" Foreground="White" FontWeight="Bold"/>

                        <Separator Margin="0,5"/>

                        <Border Background="#FFF3E0" CornerRadius="3" Padding="8" Margin="0,5">
                            <StackPanel>
                                <TextBlock Text="手动添加地址锁定 (Manual Add Lock)" FontSize="12" FontWeight="Bold" Foreground="#E65100" Margin="0,0,0,5"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="60"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="地址(Addr):" VerticalAlignment="Center"/>
                                            <TextBox x:Name="TxtManualAddress" Grid.Column="1" Text="20000000" FontFamily="Consolas" Margin="5,2"/>
                                        </Grid>
                                        <Grid Margin="0,2">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="60"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="数值(Val):" VerticalAlignment="Center"/>
                                            <TextBox x:Name="TxtManualValue" Grid.Column="1" Text="100" FontFamily="Consolas" Margin="5,2"/>
                                        </Grid>
                                    </StackPanel>
                                    <Button Grid.Column="1" Content="添加 (Add)" Click="BtnManualAdd_Click" Width="60" Margin="5,0,0,0" Background="#FFB74D"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <Grid Margin="0,10,0,5">
                            <TextBlock Text="数值锁定列表 (Value Freeze List)" FontSize="16" FontWeight="Bold" VerticalAlignment="Center"/>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="保存 (Save)" Click="SaveFrozenList_Click" Width="55" Margin="2,0" Background="#E3F2FD" FontSize="11"/>
                                <Button Content="载入 (Load)" Click="LoadFrozenList_Click" Width="55" Margin="2,0" Background="#E8F5E9" FontSize="11"/>
                            </StackPanel>
                        </Grid>

                        <ListBox x:Name="FreezeListUI" Height="140" MouseDoubleClick="FreezeListUI_MouseDoubleClick" BorderBrush="#DDD">
                            <ListBox.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="移除选中锁定 (Remove Selected)" Click="MenuRemoveFreeze_Click"/>
                                    <MenuItem Header="清空所有锁定 (Clear All)" Click="MenuClearAllFreeze_Click"/>
                                </ContextMenu>
                            </ListBox.ContextMenu>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding DisplayInfo}" Foreground="#D32F2F" Padding="2"/>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                        <Border Background="#F0F0F0" CornerRadius="3" Margin="0,10" Padding="8">
                            <StackPanel>
                                <TextBlock Text="修改选中项数值 (Edit Selected Value):" FontSize="11" Margin="0,0,0,5" Foreground="#666"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBox x:Name="TxtEditFrozenValue" Grid.Column="0" Padding="4" VerticalContentAlignment="Center" FontFamily="Consolas"/>
                                    <Button Grid.Column="1" Content="更新 (Update)" Click="BtnUpdateFreeze_Click" Width="70" Margin="5,0,0,0" Background="#4CAF50" Foreground="White" FontWeight="Bold"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <TextBlock Text="Tip: Double-click list item to unlock; Double-click search result to jump in Hex Editor. (提示：双击列表项取消锁定；双击搜索结果定位内存。)" 
                                   FontSize="10" Foreground="Gray" TextWrapping="Wrap" Margin="0,5"/>

                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>
    </Grid>
</Window>